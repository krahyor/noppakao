{% extends "base/default-page.html" %}
{% from '/components/dialog_state.html' import FailDialog , SuccessDialog , FirstBloodDialog %}

{% block content %}

{% if dialog_state['status'] == "fail" %}
{{ FailDialog() }}
{% endif %}
{% if dialog_state['status'] == "first_blood" %}
{{ FirstBloodDialog() }}
{% endif %}
{% if dialog_state['status'] == "success" %}
{{ SuccessDialog() }}
{% endif %}

<div class="ui large top fixed menu" style="background-color: rgb(50, 78, 156); border-radius: 0 !important;">
	<a class="item" style="color: white;">R202 logo</a>
	<a class="launch icon item" style="gap: 10px; color: white;"><i class="content icon"></i></a>
	<a class="item" style="color: white;"><i class="user tie icon"></i>{{ current_user.display_name }}</a>
	{% for team in teams %}
	{% for member in team.members %}
	{% if current_user.id == member.id %}
	<a class="item" style="color: white;">
		<i class="users icon"></i>{{ team.name }}
	</a>
	{% endif %}
	{% endfor %}
	{% endfor %}

	<div class="right menu">
		<div class="item" style="color: white;">
			<p id="ipaddress"></p>
		</div>
		<a id="current-time" class="item" style="color: white;"><i class="compass outline icon"></i><span
				id="time-display"></span></a>
		{% if event %}
		<a class="item" style="color: white;">
			<p id="countdown"></p>
		</a>
		{% endif %}
		<a class="item" style="color: white;" href="{{url_for('accounts.logout')}}"><i class="power off icon"
				style="color: red;"></i>Logout</a>
	</div>
</div>

<div class="ui secondary menu" style="font-size: medium">
	<div class="item">
		<h3><i class="star icon"></i> Challenges </h3>
	</div>
	{% if event.type == "team" %}
	<div class="item">
		<i class="user friends icon"></i> Team Rank
	</div>
	{% else %}
	<div class="item">
		<i class="user friends icon"></i> Solo Rank
	</div>
	{% endif %}
	<div class="right menu">
		{% if event.type == "team" %}
		<div class="item">
			<i class="user tie icon"></i> Individual Score : {{ event.competitor_score() }}
		</div>
		<div class="item">
			<i class="user tie icon"></i> Individual Rank 0
		</div>
		<div class="item">
			<i class="user friends icon"></i> Team Score {{ event.team_score() }}
		</div>
		<div class="item">
			<i class="user friends icon"></i> Team Rank 0
		</div>
		{% else %}
		<div class="item">
			<i class="user friends icon"></i> Competitor Score : {{ event.competitor_score() }}
		</div>
		{% endif %}
	</div>
</div>

<div class="ui grid center aligned" style="height: calc(100vh - 12vh); overflow: hidden;">
	{% for i in range((event_categorys|length)) %}
	<div class="five wide column card-trigger" id="card-template">
		<div class="ui cards">
			<div class="ui fluid card">
				<div class="content">
					<div class="header">
						<i class="chess queen icon" style="visibility: visible;"></i>
						Question Category {{ event_categorys[i].name }}
					</div>
					<div class="content" style="margin-top: 1rem;">
						<table class="ui table" style="border: none !important;">
							<thead>
								<tr>
									<th class="one wide"></th>
									<th class="eight wide">Challenges</th>
									<th class="one wide center aligned">Point</th>
									<th class="one wide center aligned"><i class="tint icon" style="color: red;"></i>
									</th>
									<th class="one wide center aligned"><i class="key icon"
											style="color: rgb(255, 196, 0);"></i></th>
									<th class="one wide center aligned"><i class="skull crossbones icon"></i></th>
									<th class="one wide center aligned">Solves</th>
									<th class="one wide center aligned"><i class="flag checkered icon"></i></th>
								</tr>
							</thead>
							<tbody>
								{% for event_challenge in event_challenges %}
								{% if event_categorys[i].name == event_challenge.challenge.category.name %}
								<tr class="clickable-row" data-challenge-id="{{ event_challenge.challenge.id }}">
									<td><i class="cube icon" style="color: #386CAF;"></i></td>
									<td class="clickable-name" onclick="showQuestion('{{ event_challenge.id }}')"><a>{{
											event_challenge.challenge.name }}</a></td>
									<td class="center aligned">{{ event_challenge.success_score }}</td>
									<td class="center aligned">{{ event_challenge.first_blood_score }}</td>
									<td class="center aligned">{{ event_challenge.hint_score }}</td>
									<td class="center aligned">{{ event_challenge.fail_score }}</td>
									<td class="center aligned">{{ event_challenge.total_solve_challenge() }}</td>
									{% if event_challenge.solve_challenge() %}
									<td class="center aligned"><i class="trophy icon"
											style="color: rgb(255, 196, 0);"></i></td>
									{% else %}
									<td class="center aligned"><i class="times circle icon" style="color: red;"></i>
									</td>
									{% endif %}
								</tr>

								<div class="ui small modal {{ event_challenge.id }}">
									<div class="header">Challenge Details</div>
									{% for challenge in challenges %}
									{% if challenge.id == event_challenge.challenge.id %}
									<div class="content">
										<div class="ui segment">
											<p>{{ challenge.description }}</p>
											{% if challenge.challenge_url %}
											<p>
												Link URL: <a href="{{ challenge.challenge_url }}" target="_blank">{{
													challenge.challenge_url }}</a>
											</p>
											{% endif %}
										</div>
										{% if not event_challenge.solve_challenge() %}
										<form method="GET"
											action="{{ url_for('events.submit_challenge', event_id=event.id, challenge_id=event_challenge.id) }}">
											<div class="ui fluid action input">
												<input type="text" id="answer" name="answer"
													placeholder="Enter your answer...">
												<button type="submit" class="ui big button"
													style="background-color: rgb(103, 151, 190); color: rgb(255, 255, 255);">
													Submit
												</button>
											</div>
										</form>
										{% else %}
										<div class="ui message success text" style="margin-top: auto;">
											Challenge Success
										</div>
										{% endif %}
									</div>
									{% endif %}
									{% endfor %}
								</div>
								{% endif %}
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>



{% endblock %}

{% block additional_js %}
<style>
	@keyframes flash {
		0% {
			opacity: 1;
		}

		50% {
			opacity: 0;
		}

		100% {
			opacity: 1;
		}
	}

	.flash-red {
		color: red;
		animation: flash 1s infinite;
	}

	body {
		overflow: hidden;
	}
</style>
<script type="text/javascript">
	function updateIP() {
		fetch('https://api.ipify.org?format=json')
			.then(response => response.json())
			.then(data => {
				document.getElementById('ipaddress').innerHTML = `<i class="tv icon"></i>${data.ip}`;
			})
	}

	document.addEventListener('DOMContentLoaded', function () {
		updateIP();
	});
</script>

<script>
	function showQuestion(submit_flag) {
		submit_flag ? $('.ui.small.modal.' + submit_flag).modal('show') : $('.ui.small.modal').modal('hide');
	}
</script>

<script type="text/javascript">
	function countdown(ended_date) {
		const countDownDate = new Date(ended_date).getTime();

		const x = setInterval(function () {
			const now = new Date().getTime();
			const distance = countDownDate - now;

			const days = Math.floor(distance / (1000 * 60 * 60 * 24));
			const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
			const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
			const seconds = Math.floor((distance % (1000 * 60)) / 1000);

			document.getElementById("countdown").innerHTML = '<i class="clock outline icon"></i>' + days + "d " + hours + "h "
				+ minutes + "m " + seconds + "s ";

			if (distance < 0) {
				clearInterval(x);
				document.getElementById("countdown").innerHTML = '<i class="clock outline icon"></i> Out Of Time';
				document.getElementById("countdown").classList.add("flash-red");
			}
		}, 1000);
	}

	window.onload = function () {
		const ended_date = "{{ event.ended_date }}";
		console.log("Initial Ended Date:", ended_date);
		countdown(ended_date);
	}
</script>

<script type="text/javascript">
	function updateTime() {
		const now = new Date();
		let hours = (now.getUTCHours() + 7) % 24; // Ensure hours don't exceed 24
		let minutes = now.getUTCMinutes();
		hours = hours < 10 ? '0' + hours : hours;
		minutes = minutes < 10 ? '0' + minutes : minutes;
		document.getElementById('time-display').innerHTML = `${hours}:${minutes} (UTC+7)`;
	}
	setInterval(updateTime, 1000);
	updateTime();
</script>

<script type="text/javascript">
	$(document).ready(function () {
		$('.left.sidebar.menu')
			.sidebar('attach events', '.launch.icon.item', 'show');

		$('.launch.icon.item').removeClass('disabled');

		$('.ui.dropdown').dropdown();
	});
</script>
{% endblock %}