{% extends "base/default-page.html" %}

{% block content %}
<div class="ui large top fixed menu" style="background-color: rgb(50, 78, 156); border-radius: 0 !important;">
	<a class="item" style="color: white;">R202 logo</a>
	<a class="launch icon item" style="gap: 10px; color: white;"><i class="content icon"></i></a>
	<a class="item" style="color: white;"><i class="user tie icon"></i>{{ current_user.display_name }}</a>
	{% for team in teams %}
	{% for member in team.members %}
	{% if current_user.id == member.id %}
	<a class="item" style="color: white;">
		<i class="users icon"></i>{{ team.name }}
	</a>
	{% endif %}
	{% endfor %}
	{% endfor %}

	<div class="right menu">
		<a class="item" style="color: white;"><i class="tv icon"></i>IP address</a>
		<a id="current-time" class="item" style="color: white;"><i class="compass outline icon"></i><span
				id="time-display"></span></a>
		{% if event %}
		<a class="item" style="color: white;">
			<p id="countdown"></p>
		</a>
		{% endif %}
		<a class="item" style="color: white;" href="{{url_for('accounts.logout')}}"><i class="power off icon"
				style="color: red;"></i>Logout</a>
	</div>
</div>

<div class="ui secondary menu" style="font-size: medium">
	<div class="item">
		<h3><i class="star icon"></i> Challenges </h3>
	</div>
	<div class="item">
		<i class="user friends icon"></i> Team Rank
	</div>
	<div class="right menu">
		<div class="item">
			<i class="user friends icon"></i> Team Score 0
		</div>
		<div class="item">
			<i class="user friends icon"></i> Team Rank 0
		</div>
	</div>
</div>

<div class="ui grid center aligned" style="height: calc(100vh - 12vh); overflow: hidden;">
	{% for i in range((event_categorys|length)) %}
	<div class="five wide column card-trigger" id="card-template">
		<div class="ui cards">
			<div class="ui fluid card">
				<div class="content">
					<div class="header">
						<i class="chess queen icon" style="visibility: visible;"></i>
						Question Category {{ event_categorys[i].name }}
					</div>
					<div class="content" style="margin-top: 1rem;">
						<table class="ui table" style="border: none !important;">
							<thead>
								<tr>
									<th class="one wide"></th>
									<th class="six wide">Challenges</th>
									<th class="two wide center aligned">Point</th>
									<th class="two wide center aligned"><i class="tint icon" style="color: red;"></i>
									</th>
									<th class="two wide center aligned"><i class="key icon"
											style="color: rgb(255, 196, 0);"></i></th>
									<th class="two wide center aligned">Solves</th>
								</tr>
							</thead>
							<tbody>
								{% for event_challenge in event_challenges %}
								{% if event_categorys[i].name == event_challenge.challenge.category.name %}
								<tr class="clickable-row" data-challenge-id="{{ event_challenge.challenge.id }}">
									<td><i class="cube icon" style="color: #386CAF;"></i></td>
									<td class="clickable-name"><a>{{ event_challenge.challenge.name }}</a></td>
									<td class="center aligned">{{ event_challenge.success_score }}</td>
									<td class="center aligned">{{ event_challenge.first_blood_score }}</td>
									<td class="center aligned">{{ event_challenge.hint_score }}</td>
									<td class="center aligned">{{ event_challenge.fail_score }}</td>
								</tr>
								{% endif %}
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>

<div class="ui modal" id="challenge-modal">
	<div class="header">Challenge Details</div>
	<div class="content">
		<div class="ui segment">
			<p id="challenge-description" class="modal-description"></p>
			<p>
				<a id="challenge-url" href="#" target="_blank" class="ui link" style="display: none;">Challenge URL</a>
			</p>
		</div>
		<div id="challenge-hint" class="modal-hint ui blue segment" style="display: none;"></div>
		<a id="show-hint-button" class="ui primary tertiary button" style="display: none;"><i
				class="eye outline icon"></i>Show Hint</a>
		<form class="ui form" style="margin-top: 2rem;">
			<div class="field">
				<label>Answer Flag</label>
				<input type="text" name="answer-flag" placeholder="Answer Flag">
			</div>
		</form>
	</div>
	<div class="actions">
		<div class="ui button negative">Cancel</div>
		<div class="ui button positive">Submit</div>
	</div>
</div>

{% endblock %}

{% block additional_js %}
<style>
	@keyframes flash {
		0% {
			opacity: 1;
		}

		50% {
			opacity: 0;
		}

		100% {
			opacity: 1;
		}
	}

	.flash-red {
		color: red;
		animation: flash 1s infinite;
	}
</style>

<script type="text/javascript">
	function showChallengeDetails(challengeId) {
		$.ajax({
			url: '/api/challenge/' + challengeId,
			type: 'GET',
			success: function (response) {
				$('#challenge-description').text(response.description);

				if (response.challenge_url) {
					$('#challenge-url')
						.attr('href', response.challenge_url)
						.text(response.name)
						.show();
				} else {
					$('#challenge-url').hide();
				}

				if (response.hint) {
					$('#show-hint-button').show().off('click').on('click', function () {
						$('#challenge-hint').text(response.hint).show();
						$(this).hide();
					});
				} else {
					$('#show-hint-button').hide();
					$('#challenge-hint').hide();
				}
				$('#challenge-modal').modal('show');
			},
		});
	}

	$(document).ready(function () {
		$('.clickable-name').on('click', function () {
			var challengeId = $(this).closest('.clickable-row').data('challenge-id');
			if (challengeId) {
				showChallengeDetails(challengeId);
			}
		});

		$('#challenge-modal').modal({
			onHidden: function () {
				$('#challenge-hint').hide();
				$('#show-hint-button').show();
			}
		});
	});
</script>

<script type="text/javascript">
	function countdown(ended_date) {
		const countDownDate = new Date(ended_date).getTime();

		const x = setInterval(function () {
			const now = new Date().getTime();
			const distance = countDownDate - now;

			const days = Math.floor(distance / (1000 * 60 * 60 * 24));
			const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
			const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
			const seconds = Math.floor((distance % (1000 * 60)) / 1000);

			document.getElementById("countdown").innerHTML = '<i class="clock outline icon"></i>' + days + "d " + hours + "h "
				+ minutes + "m " + seconds + "s ";

			if (distance < 0) {
				clearInterval(x);
				document.getElementById("countdown").innerHTML = '<i class="clock outline icon"></i> Out Of Time';
				document.getElementById("countdown").classList.add("flash-red");
			}
		}, 1000);
	}

	window.onload = function () {
		const ended_date = "{{ event.ended_date }}";
		console.log("Initial Ended Date:", ended_date);
		countdown(ended_date);
	}
</script>

<script type="text/javascript">
	function updateTime() {
		const now = new Date();
		let hours = (now.getUTCHours() + 7) % 24; // Ensure hours don't exceed 24
		let minutes = now.getUTCMinutes();
		hours = hours < 10 ? '0' + hours : hours;
		minutes = minutes < 10 ? '0' + minutes : minutes;
		document.getElementById('time-display').innerHTML = `${hours}:${minutes} (UTC+7)`;
	}
	setInterval(updateTime, 1000);
	updateTime();
</script>

<script type="text/javascript">
	$(document).ready(function () {
		$('.left.sidebar.menu')
			.sidebar('attach events', '.launch.icon.item', 'show');

		$('.launch.icon.item').removeClass('disabled');

		$('.ui.dropdown').dropdown();
	});
</script>
{% endblock %}